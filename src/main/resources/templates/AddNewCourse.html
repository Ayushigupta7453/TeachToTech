<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add Course</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      background-color: #f4f4f4;
      font-family: Arial, sans-serif;
    }
    .content {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      width: 100%;
      height: 100%;
      padding-top: 30px;
      box-sizing: border-box;
    }
    .card {
      border: none;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      padding: 30px;
      background-color: white;
      width: 90%;
      max-width: 2000px;
      box-sizing: border-box;
      margin-top: 50px;
      min-width: 800px;
    }
    .card-title {
      font-size: 25px;
      color: #5fcf80;
      font-weight: bold;
      margin-bottom: 20px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      font-size: 14px;
      color: #333;
    }
    .form-control {
      width: 100%;
      padding: 12px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }
    .form-control:focus {
      border-color: #5fcf80;
      outline: none;
    }
    .read-more {
      background-color: #5fcf80;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 12px 20px;
      text-decoration: none;
      font-size: 16px;
      margin-top: 20px;
      width: 100%;
    }
    .read-more:hover {
      background-color: #4caf6a;
    }
    .back-arrow {
      display: flex;
      align-items: center;
      cursor: pointer;
      margin-bottom: 20px;
    }
    .arrow {
      width: 0;
      height: 0;
      border-top: 10px solid transparent;
      border-bottom: 10px solid transparent;
      border-right: 15px solid #4CAF50;
      margin-right: 10px;
    }
    .arrow:hover {
      border-right-color: #45a049;
    }
    .back-text {
      font-size: 14px;
      color: #4CAF50;
      font-weight: bold;
    }
    .back-text:hover {
      color: #45a049;
    }

  </style>
</head>
<body>
  <div class="content">
    <div class="back-arrow" onclick="history.back()">
      <div class="arrow"></div>
      <p class="back-text">Go back</p>
    </div>
    <div class="card">
      <h3 class="card-title">Add New Course</h3>
      <form id="addCourseForm">
        <!-- Title Field -->
        <div class="form-group">
          <label for="title">Course Title</label>
          <input type="text" id="title" name="title" class="form-control" required>
        </div>

        <!-- Course Name Field -->
        <div class="form-group">
          <label for="courseName">Course Name</label>
          <input type="text" id="courseName" name="courseName" class="form-control" required>
        </div>

        <!-- Description Field -->
        <div class="form-group">
          <label for="description">Course Description</label>
          <textarea id="description" name="description" class="form-control" rows="4" required></textarea>
        </div>

        <!-- Category Field -->
        <div class="form-group">
          <label for="category">Category</label>
          <select id="category" name="category" class="form-control" required>
            <option value="" disabled selected>Select Category</option>
          </select>
          <span id="categoryError" class="text-danger"></span>
        </div>

        <!-- Image Field -->
        <div class="form-group">
          <label for="image">Course Image URL</label>
          <input type="text" id="image" name="image" class="form-control">
        </div>

        <!-- Duration Field -->
        <div class="form-group">
          <label for="duration">Course Duration (hours)</label>
          <input type="number" id="duration" name="duration" class="form-control" required>
        </div>

        <!-- Price Field -->
        <div class="form-group">
          <label for="price">Price</label>
          <input type="number" id="price" name="price" class="form-control" required>
        </div>

        <!-- Modules Field -->
        <div class="form-group">
          <label for="modules">Modules</label>
          <input type="text" id="modules" name="modules" class="form-control">
        </div>

        <!-- Trainers Field -->
        <div class="form-group">
          <label for="trainers">Select Trainers</label>
          <select id="trainers" name="trainers" class="form-control" multiple required>
            <option value="" disabled selected>Select Trainer</option>

          </select>
        </div>

        <!-- Submit Button -->
        <button type="submit" class="read-more">Add Course</button>
      </form>
    </div>
  </div>
  <script>
document.addEventListener('DOMContentLoaded', async function () {
  const categorySelect = document.getElementById('category');
  const errorSpan = document.getElementById('categoryError');
  const trainersSelect = document.getElementById('trainers');

  // Function to load categories
  async function loadCategories() {
    try {
      const response = await fetch('/category/getallcategory');
      if (!response.ok) throw new Error('Failed to fetch categories');
      const data = await response.json();
      console.log("Categories", data);
      data.forEach(category => {
        const option = document.createElement('option');
        option.value = category.categoryId;
        option.textContent = category.name;
        categorySelect.appendChild(option);
      });
    } catch (error) {
      errorSpan.textContent = 'Unable to load categories. Please try again later.';
      console.error('Error fetching categories:', error);
    }
  }

  // Function to load trainers
  async function loadTrainers() {
    try {
      const response = await fetch('/api/trainer/get');
      console.log(response);
      if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
      const data = await response.json();
      console.log("Trainers", data);
      data.forEach(trainer => {
        const option = document.createElement('option');
        option.value = trainer.trainerId;
        option.textContent = trainer.trainerName;
        trainersSelect.appendChild(option);
      });
    } catch (error) {
      console.error('Error fetching trainers:', error);
    }
  }

  // Load categories and trainers
  await Promise.all([loadCategories(), loadTrainers()]);

  // Handle form submission
  const form = document.getElementById('addCourseForm');
  form.addEventListener('submit', async event => {
    event.preventDefault(); // Prevent the default form submission

    const formData = new FormData(form);

    // Build the payload object
    const payload = {
      title: formData.get('title') || '',
      courseName: formData.get('courseName') || '',
      description: formData.get('description') || '',
      category: {
        categoryId: parseInt(formData.get('category'), 10) || null, // Get category_id from the selected option
      },
      image: formData.get('image') || '',
      duration: parseInt(formData.get('duration'), 10) || null,
      price: parseFloat(formData.get('price')) || null,
      modules: formData.get('modules') || '',
      trainers: formData.getAll('trainers').map(trainerId => ({
        trainerId: parseInt(trainerId, 10), // Get trainer_id from selected trainers
      })),
    };

    // Remove keys with `null` values to avoid sending invalid data
    Object.keys(payload).forEach(key => {
      if (payload[key] === null || payload[key] === '' || payload[key] === 'undefined') {
        delete payload[key];
      }
    });

    // Log the payload in the console before sending
    console.log('Payload to be sent:', payload);

    try {
      const response = await fetch('/api/courses/add/pending', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });

      if (response.ok) {
        // Check if the response has a body
        if (response.status === 200) {
          // No content returned, just display success
          alert('Course added and pending approval!');
        } else {
          // If there's a response body, parse it as JSON (optional)
          const result = await response.json();
          console.log('Response:', result);
          alert('Course added successfully!');
        }
      } else {
        const error = await response.text();
        alert(`Failed to add course: ${error}`);
        console.error('Error:', error);
      }
    } catch (error) {
      console.error('Error submitting form:', error);
      // alert('An error occurred while adding the course. Please try again.');
    }
  });
});


  </script>
  
</body>
</html>
